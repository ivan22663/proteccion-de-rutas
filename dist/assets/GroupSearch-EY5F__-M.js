import{_ as Ae,r as A,a5 as Ve,c as Ce,a as i,o as $,d as s,b as l,h as W,g as X,f as Y,s as ee,l as y,j as w,t as u,e as o,v as Te,i as _,af as M,ae as Ee,z as Se}from"./index-D8k0Z2VW.js";import{Q as Fe,a as Ie}from"./QItemLabel-BiKvV_tR.js";import{Q as j}from"./QSelect-CCFBgF8v.js";import{Q as qe}from"./QTooltip-BIz5X8HU.js";import{Q as te}from"./QBadge-pToOuXWH.js";import{Q as se}from"./QTd-Dz2_L_T4.js";import{Q as Pe}from"./QForm-BHoNUr4c.js";import{Q as ze}from"./QPage-CDUm3vNP.js";import{C as De}from"./ClosePopup-DkFGp95i.js";import{g as L,p as Qe}from"./apiClient-Vvvjylwf.js";import{u as ke}from"./useNotifications-C15CMF32.js";import{u as Be}from"./useEntityManager-6kUzRwOq.js";import{B as Ue}from"./BackButton-OAicZK4q.js";import{P as $e}from"./PageHeader-BZtJRD6F.js";import{T as Me}from"./Table-DrGgNztj.js";import{M as ae}from"./Modal-CwwUMTwV.js";import{B as F}from"./Button-ByZOtwGJ.js";import{_ as je}from"./ButtonTableOptions-ivpzFDPv.js";import"./position-engine-BrzQKXCo.js";import"./selection-CjJDPdFp.js";import"./format-DyQxkAtJ.js";import"./QList-D6hH9GPe.js";import"./QLinearProgress-C9Sex94R.js";const Le={class:"q-mb-lg"},Re={class:"full-width row"},Ge={class:"col-12"},Ze={class:"container q-mb-xl"},He={class:"row justify-center"},Je={class:"col-12 col-md-8"},Oe={key:0,class:"apprentices-section"},Ke={class:"section-header flex items-center justify-between q-mb-lg"},We={class:"text-h5 text-weight-bold"},Xe={class:"text-subtitle2 text-grey-7 q-mt-xs"},Ye={class:"flex items-center q-gutter-sm"},et={class:"filters-wrapper flex items-center justify-between q-mb-lg"},tt={class:"filters-left flex items-center bg-white"},st={class:"filter-item search"},at={class:"filter-item status"},ot={class:"q-pa-md flex flex-center column text-grey full-width"},lt={class:"modal-header"},it={class:"text-h6 flex items-center"},nt={class:"modal-content-grid"},rt={class:"modal-column"},dt={class:"modal-column"},ut={class:"modal-header"},ct={class:"text-h6 flex items-center"},mt={key:0,class:"modal-content-grid"},pt={class:"modal-column"},ft={class:"data-grid"},vt={class:"data-row"},gt={class:"data-value"},bt={class:"data-row"},ht={class:"data-value"},yt={class:"data-row"},wt={class:"data-value"},_t={class:"data-row"},Nt={class:"data-value"},xt={class:"data-row"},At={class:"data-value"},Vt={class:"modal-column"},Ct={class:"data-grid"},Tt={class:"data-row"},Et={class:"data-value"},St={class:"data-row"},Ft={class:"data-value"},It={class:"data-row"},qt={class:"data-value"},Pt={class:"data-row"},zt={class:"data-value"},Dt={__name:"GroupSearch",setup(Qt){const m=A(null),f=A([]),N=A([]),I=A(!1),q=A({}),P=A(null),{error:V,success:R}=ke(),oe=()=>({_id:"",documentType:"",documentNumber:"",firstName:"",lastName:"",phone:"",emailInstitutional:"",emailPersonal:"",fiche:""}),z={list:"/apprentices/listApprentice",create:"/apprentices/saveApprentice"},S={listError:"Error al listar aprendices",createSuccess:"Aprendiz agregado correctamente",createError:"Error al agregar el aprendiz",noData:"No hay aprendices registrados en esta ficha"},G=a=>{const e=q.value[m.value]||m.value;return{documentNumber:a.documentNumber?.trim(),documentType:a.documentType,recordNumber:[{fiche:e}],firstName:a.firstName?.trim(),lastName:a.lastName?.trim(),email:{institutional:a.emailInstitutional?.trim(),personal:a.emailPersonal?.trim()},phone:a.phone?.trim(),password:a.documentNumber?.trim()}},Z=a=>!a||!a.fiche?null:typeof a.fiche=="string"||typeof a.fiche=="number"?a.fiche.toString().trim():typeof a.fiche=="object"?(a.fiche.number||a.fiche.code||a.fiche._id||a.fiche.fiche)?.toString().trim():(a.number||a.code)?.toString().trim(),H=a=>{const t=a?.msg?.Apprentice||[];if(!m.value)return{data:[],total:0};let e=t.filter(h=>!h.recordNumber||!Array.isArray(h.recordNumber)?!1:h.recordNumber.some(U=>Z(U)===m.value.toString().trim()));const d=b.value.search?.trim().toLowerCase();d&&(e=e.filter(h=>{const U=`${h.firstName||""} ${h.lastName||""}`.toLowerCase(),K=(h.documentNumber||"").toString().toLowerCase();return U.includes(d)||K.includes(d)})),b.value.status!==""&&b.value.status!==null&&(e=e.filter(h=>h.status===b.value.status));const{page:n,rowsPerPage:p}=v.value,c=(n-1)*p,xe=c+p;return{data:e.slice(c,xe),total:e.length}},{loading:C,loadingTable:D,rows:le,showAddDialog:T,showDetailDialog:Q,selectedEntity:ie,formData:r,filtersData:b,pagination:v,resetPaginationState:k,openFormDialog:ne,closeFormDialog:re,openDetailsDialog:de,handleAddDialogVisibility:B}=Be({entityName:"aprendiz",entityNamePlural:"apprentices",getDefaultFormData:oe,endpoints:z,messages:S,buildPayload:G,processResponse:H}),E=le,g=ie,ue=ne,ce=re,me=de,x=async()=>{if(!m.value){E.value=[],v.value.rowsNumber=0;return}D.value=!0;try{const a={page:1,limit:1e4},t=await L(z.list,{params:a});console.log("Response from API:",t),console.log("Aprendices recibidos:",t?.msg?.Apprentice?.length||0);const e=H(t);console.log("Aprendices procesados:",e.data.length),console.log("Total después de filtrar:",e.total),E.value=e.data,v.value.rowsNumber=e.total}catch(a){const t=a?.response?.data?.msg||a?.message||S.listError;V(t),E.value=[],v.value.rowsNumber=0}finally{D.value=!1}},pe=a=>{a?.pagination&&(v.value={page:a.pagination.page,rowsPerPage:a.pagination.rowsPerPage,rowsNumber:a.pagination.rowsNumber??v.value.rowsNumber},x())},fe=()=>{k(),x()},ve=()=>{k(),x()},J=async a=>{try{return((await L("/apprentices/listApprentice",{params:{page:1,limit:10,search:a}}))?.msg?.Apprentice||[]).find(n=>n.documentNumber?.toString()===a.toString())||null}catch{return null}},O=async()=>{if(P.value&&!await P.value.validate()){V("Por favor complete todos los campos requeridos correctamente");return}C.value=!0;const a=await J(r.value.documentNumber?.trim());if(a){const e=a.recordNumber?.map(Z).filter(Boolean);if(e&&e.length>0){const d=e.join(", ");V(`El aprendiz con documento ${r.value.documentNumber} ya está registrado en la(s) ficha(s): ${d}. Un aprendiz solo puede estar en una ficha a la vez.`),C.value=!1;return}}const t=G(r.value);try{const e=await Qe(z.create,t),d=e?.msg||e?.message||e?.data?.msg||S.createSuccess;R(d),T.value=!1,B(!1),setTimeout(async()=>{await x()},300)}catch(e){if(e?.response?.status===500&&(await new Promise(p=>setTimeout(p,500)),await J(r.value.documentNumber?.trim()))){R("Aprendiz agregado correctamente"),T.value=!1,B(!1),setTimeout(async()=>{await x()},300),C.value=!1;return}let d=S.createError;if(e?.response?.data?.errors){const n=e.response.data.errors;Array.isArray(n)?d=n.map(c=>typeof c=="string"?c:c.msg?c.msg:c.message?c.message:JSON.stringify(c)).join(", "):typeof n=="string"&&(d=n)}else e?.response?.data?.msg?d=e.response.data.msg:e?.message&&(d=e.message);V(d)}finally{C.value=!1}},ge=[{label:"Cédula de Ciudadanía",value:"CC"},{label:"Tarjeta de Identidad",value:"TI"},{label:"Cédula de Extranjería",value:"CE"}],be=[{label:"Todos los estados",value:""},{label:"Activo",value:0},{label:"Inactivo",value:1}],he=[{name:"documentType",label:"Tipo Doc.",align:"center",field:"documentType"},{name:"documentNumber",label:"N° Documento",align:"center",field:"documentNumber"},{name:"firstName",label:"Nombres",align:"center",field:"firstName"},{name:"lastName",label:"Apellidos",align:"center",field:"lastName"},{name:"phone",label:"Teléfono",align:"center",field:"phone"},{name:"status",label:"Estado",align:"center",field:"status"},{name:"options",label:"Acciones",align:"center"}],ye=(a,t)=>{t(()=>{if(a==="")N.value=[...f.value];else{const e=a.toLowerCase();N.value=f.value.filter(d=>d.toLowerCase().includes(e))}})},we=async a=>{a&&(m.value=a,k(),await x())},_e=()=>{m.value=null,b.value.search="",b.value.status="",E.value=[],v.value.rowsNumber=0,v.value.page=1},Ne=async()=>{I.value=!0;try{const t=await L("/fiches/listFiche",{params:{page:1,limit:1e3}}),e=t?.msg?.fiches||t?.msg||[];q.value={},Array.isArray(e)&&(f.value=e.map(n=>{let p=null,c=null;if(n&&typeof n=="object"){if(p=n.number||n.fiche||n.code,c=n._id||n.id,p&&c&&(q.value[p.toString()]=c),p)return p.toString()}else if(n)return n.toString();return null}).filter(n=>n),["2926076","2926065","2926034","2589667"].forEach(n=>{f.value.includes(n)||f.value.push(n)}),f.value.sort((n,p)=>parseInt(n)-parseInt(p)),N.value=[...f.value]),f.value.length===0&&(f.value=["2926076","2926065","2926034","2589667"],N.value=[...f.value])}catch{V("Error al cargar las fichas disponibles"),f.value=["2926076","2926065","2926034","2589667"],N.value=[...f.value]}finally{I.value=!1}};return Ve(async()=>{await Ne()}),(a,t)=>($(),Ce(ze,{class:"q-pa-md apprentices-by-fiche-page"},{default:i(()=>[s("div",Le,[l(Ue)]),s("div",Re,[s("div",Ge,[l(Y,{class:"shadow-1 hero-card q-mb-xl"},{default:i(()=>[l(ee,null,{default:i(()=>[l($e,{title:"Aprendices por Ficha",description:"Busca una ficha y visualiza los aprendices asociados."})]),_:1})]),_:1}),s("div",Ze,[s("div",He,[s("div",Je,[l(j,{modelValue:m.value,"onUpdate:modelValue":[t[0]||(t[0]=e=>m.value=e),we],options:N.value,loading:I.value,"use-input":"","input-debounce":"300",placeholder:"Buscar número de ficha...",outlined:"",class:"search-select",behavior:"menu",onFilter:ye},{prepend:i(()=>[l(w,{name:"search",color:"grey-6",size:"20px"})]),"no-option":i(()=>[l(Fe,null,{default:i(()=>[l(Ie,{class:"text-grey"},{default:i(()=>[...t[13]||(t[13]=[y(" No hay resultados ",-1)])]),_:1})]),_:1})]),_:1},8,["modelValue","options","loading"])])])]),m.value?($(),W("div",Oe,[l(Y,{class:"shadow-1"},{default:i(()=>[l(ee,null,{default:i(()=>[s("div",Ke,[s("div",null,[s("div",We,[l(w,{name:"school",class:"q-mr-sm",color:"primary"}),y(" Aprendices de la Ficha "+u(m.value),1)]),s("div",Xe," Total de aprendices: "+u(o(v).rowsNumber),1)]),s("div",Ye,[l(F,{label:"Añadir Aprendiz","custom-class":"gradient-btn",icon:"person_add",onClick:o(ue)},null,8,["onClick"]),l(Te,{flat:"",round:"",icon:"close",color:"grey-7",size:"md",onClick:_e},{default:i(()=>[l(qe,null,{default:i(()=>[...t[14]||(t[14]=[y("Limpiar búsqueda",-1)])]),_:1})]),_:1})])]),s("div",et,[s("div",tt,[s("div",st,[l(_,{modelValue:o(b).search,"onUpdate:modelValue":[t[1]||(t[1]=e=>o(b).search=e),fe],outlined:"",dense:"",clearable:"",debounce:"600",placeholder:"Buscar por nombre o documento..."},{prepend:i(()=>[l(w,{name:"search",color:"grey-7"})]),_:1},8,["modelValue"])]),s("div",at,[l(j,{modelValue:o(b).status,"onUpdate:modelValue":[t[2]||(t[2]=e=>o(b).status=e),ve],options:be,outlined:"",dense:"","emit-value":"","map-options":"",clearable:"",label:"Filtrar por Estado"},{prepend:i(()=>[l(w,{name:"filter_list",color:"green-8"})]),_:1},8,["modelValue"])])])]),l(Me,{card:"",rows:o(E),columns:he,pagination:o(v),"onUpdate:pagination":t[3]||(t[3]=e=>M(v)?v.value=e:null),"loading-table":o(D),"row-key":"_id",onRequest:pe},{"body-cell-status":i(e=>[l(se,{props:e},{default:i(()=>[l(te,{color:e.row.status===0?"positive":"negative",class:"text-uppercase"},{default:i(()=>[y(u(e.row.status===0?"Activo":"Inactivo"),1)]),_:2},1032,["color"])]),_:2},1032,["props"])]),"body-cell-options":i(e=>[l(se,{props:e,class:"text-center table-options"},{default:i(()=>[l(je,{icon:"visibility",color:"primary",tooltip:"Ver detalles",onClick:d=>o(me)(e.row)},null,8,["onClick"])]),_:2},1032,["props"])]),"no-data":i(()=>[s("div",ot,[l(w,{name:"school",size:"2.5em",color:"grey-5"}),t[15]||(t[15]=s("div",{class:"text-subtitle2 q-mt-sm"}," No hay aprendices registrados en esta ficha ",-1))])]),_:1},8,["rows","pagination","loading-table"])]),_:1})]),_:1})])):X("",!0),l(ae,{modelValue:o(T),"onUpdate:modelValue":[t[11]||(t[11]=e=>M(T)?T.value=e:null),o(B)],width:"900px","max-width":"95vw",persistent:""},{header:i(()=>[s("div",lt,[s("div",it,[l(w,{name:"person_add",class:"q-mr-sm"}),y(" Agregar aprendiz a la ficha "+u(m.value),1)]),t[16]||(t[16]=s("div",{class:"text-caption text-grey-7 q-mt-xs"}," Ingresa el documento del aprendiz. Si ya existe en otra ficha, se mostrará un error. ",-1))])]),body:i(()=>[l(Pe,{ref_key:"apprenticeFormRef",ref:P,onSubmit:Ee(O,["prevent"])},{default:i(()=>[s("div",nt,[s("div",rt,[t[17]||(t[17]=s("div",{class:"section-title"},"Datos personales",-1)),l(j,{modelValue:o(r).documentType,"onUpdate:modelValue":t[4]||(t[4]=e=>o(r).documentType=e),filled:"",dense:"",label:"Tipo de documento *",options:ge,"emit-value":"","map-options":"",rules:[e=>!!e||"El tipo de documento es requerido"]},null,8,["modelValue","rules"]),l(_,{modelValue:o(r).documentNumber,"onUpdate:modelValue":t[5]||(t[5]=e=>o(r).documentNumber=e),filled:"",dense:"",label:"Número de documento *",mask:"##########",rules:[e=>!!e||"El número de documento es requerido",e=>/^\d{7,10}$/.test(e)||"Debe tener entre 7 y 10 dígitos"]},null,8,["modelValue","rules"]),l(_,{modelValue:o(r).firstName,"onUpdate:modelValue":t[6]||(t[6]=e=>o(r).firstName=e),filled:"",dense:"",label:"Nombres *",rules:[e=>!!e||"Los nombres son requeridos",e=>/^[a-zA-ZáéíóúÁÉÍÓÚñÑ\s]+$/.test(e)||"Solo se permiten letras"]},null,8,["modelValue","rules"]),l(_,{modelValue:o(r).lastName,"onUpdate:modelValue":t[7]||(t[7]=e=>o(r).lastName=e),filled:"",dense:"",label:"Apellidos *",rules:[e=>!!e||"Los apellidos son requeridos",e=>/^[a-zA-ZáéíóúÁÉÍÓÚñÑ\s]+$/.test(e)||"Solo se permiten letras"]},null,8,["modelValue","rules"]),l(_,{modelValue:o(r).phone,"onUpdate:modelValue":t[8]||(t[8]=e=>o(r).phone=e),filled:"",dense:"",label:"Teléfono *",mask:"##########",rules:[e=>!!e||"El teléfono es requerido",e=>/^3[0-9]{9}$/.test(e)||"Debe tener 10 dígitos y comenzar con 3"]},null,8,["modelValue","rules"])]),s("div",dt,[t[18]||(t[18]=s("div",{class:"section-title"},"Información de contacto",-1)),l(_,{modelValue:o(r).emailInstitutional,"onUpdate:modelValue":t[9]||(t[9]=e=>o(r).emailInstitutional=e),filled:"",dense:"",label:"Email institucional *",type:"email","lazy-rules":"",rules:[e=>!!e?.trim()||"El email institucional es requerido",e=>/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test((e||"").trim())||"Email inválido"]},null,8,["modelValue","rules"]),l(_,{modelValue:o(r).emailPersonal,"onUpdate:modelValue":t[10]||(t[10]=e=>o(r).emailPersonal=e),filled:"",dense:"",label:"Email personal *",type:"email","lazy-rules":"",rules:[e=>!!e?.trim()||"El email personal es requerido",e=>/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test((e||"").trim())||"Email inválido"]},null,8,["modelValue","rules"])])])]),_:1},512)]),footer:i(()=>[l(F,{label:"Cancelar","custom-class":"boton-cerrar",onClick:o(ce)},null,8,["onClick"]),l(F,{label:"Guardar","custom-class":"gradient-btn",loading:o(C),onClick:O},null,8,["loading"])]),_:1},8,["modelValue","onUpdate:modelValue"]),l(ae,{modelValue:o(Q),"onUpdate:modelValue":t[12]||(t[12]=e=>M(Q)?Q.value=e:null),width:"900px","max-width":"90vw"},{header:i(()=>[s("div",ut,[s("div",ct,[l(w,{name:"person",class:"q-mr-sm"}),y(" "+u(o(g)?.firstName)+" "+u(o(g)?.lastName),1)])])]),body:i(()=>[o(g)?($(),W("div",mt,[s("div",pt,[t[24]||(t[24]=s("div",{class:"section-title"},"Datos personales",-1)),s("div",ft,[s("div",vt,[t[19]||(t[19]=s("div",{class:"text-weight-bold"},"Tipo de documento:",-1)),s("div",gt,u(o(g)?.documentType||"-"),1)]),s("div",bt,[t[20]||(t[20]=s("div",{class:"text-weight-bold"},"Número de documento:",-1)),s("div",ht,u(o(g)?.documentNumber||"-"),1)]),s("div",yt,[t[21]||(t[21]=s("div",{class:"text-weight-bold"},"Nombres:",-1)),s("div",wt,u(o(g)?.firstName||"-"),1)]),s("div",_t,[t[22]||(t[22]=s("div",{class:"text-weight-bold"},"Apellidos:",-1)),s("div",Nt,u(o(g)?.lastName||"-"),1)]),s("div",xt,[t[23]||(t[23]=s("div",{class:"text-weight-bold"},"Teléfono:",-1)),s("div",At,u(o(g)?.phone||"-"),1)])])]),s("div",Vt,[t[29]||(t[29]=s("div",{class:"section-title"},"Información de contacto",-1)),s("div",Ct,[s("div",Tt,[t[25]||(t[25]=s("div",{class:"text-weight-bold"},"Email institucional:",-1)),s("div",Et,u(o(g)?.email?.institutional||"-"),1)]),s("div",St,[t[26]||(t[26]=s("div",{class:"text-weight-bold"},"Email personal:",-1)),s("div",Ft,u(o(g)?.email?.personal||"-"),1)]),s("div",It,[t[27]||(t[27]=s("div",{class:"text-weight-bold"},"Ficha:",-1)),s("div",qt,u(m.value||"-"),1)]),s("div",Pt,[t[28]||(t[28]=s("div",{class:"text-weight-bold"},"Estado:",-1)),s("div",zt,[l(te,{color:o(g)?.status===0?"positive":"negative",class:"text-uppercase"},{default:i(()=>[y(u(o(g)?.status===0?"Activo":"Inactivo"),1)]),_:1},8,["color"])])])])])])):X("",!0)]),footer:i(()=>[Se(l(F,{label:"Cerrar","custom-class":"boton-cerrar"},null,512),[[De]])]),_:1},8,["modelValue"])])])]),_:1}))}},ns=Ae(Dt,[["__scopeId","data-v-887f6ce9"]]);export{ns as default};
