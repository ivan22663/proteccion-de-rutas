import{_ as we,r as P,w as S,a5 as _e,n as Ne,c as xe,a as i,u as Ae,o as Q,d as s,b as l,h as G,g as K,f as W,s as X,l as y,j as w,t as d,e as o,v as Ve,i as b,af as B,ae as qe,z as Te}from"./index-D8k0Z2VW.js";import{Q as Ce}from"./QTooltip-BIz5X8HU.js";import{Q as Y}from"./QSelect-CCFBgF8v.js";import{Q as ee}from"./QBadge-pToOuXWH.js";import{Q as te}from"./QTd-Dz2_L_T4.js";import{Q as Ee}from"./QForm-BHoNUr4c.js";import{Q as ze}from"./QPage-CDUm3vNP.js";import{C as De}from"./ClosePopup-DkFGp95i.js";import{g as U,p as Fe}from"./apiClient-Vvvjylwf.js";import{u as Ie}from"./useNotifications-C15CMF32.js";import{u as ke}from"./useEntityManager-6kUzRwOq.js";import{B as Pe}from"./BackButton-OAicZK4q.js";import{P as Se}from"./PageHeader-BZtJRD6F.js";import{T as Qe}from"./Table-DrGgNztj.js";import{M as se}from"./Modal-CwwUMTwV.js";import{B as C}from"./Button-ByZOtwGJ.js";import{_ as Be}from"./ButtonTableOptions-ivpzFDPv.js";import"./position-engine-BrzQKXCo.js";import"./selection-CjJDPdFp.js";import"./QItemLabel-BiKvV_tR.js";import"./format-DyQxkAtJ.js";import"./QList-D6hH9GPe.js";import"./QLinearProgress-C9Sex94R.js";const Ue={class:"q-mb-lg"},Me={class:"full-width row"},$e={class:"col-12"},je={key:0,class:"apprentices-section"},Re={class:"section-header flex items-center justify-between q-mb-lg"},Le={class:"text-h5 text-weight-bold"},Ze={class:"text-subtitle2 text-grey-7 q-mt-xs"},He={class:"flex items-center q-gutter-sm"},Je={class:"filters-wrapper flex items-center justify-between q-mb-lg"},Oe={class:"filters-left flex items-center bg-white"},Ge={class:"filter-item search"},Ke={class:"filter-item status"},We={class:"q-pa-md flex flex-center column text-grey full-width"},Xe={class:"modal-header"},Ye={class:"text-h6 flex items-center"},et={class:"modal-content-grid"},tt={class:"modal-column"},st={class:"modal-column"},at={class:"row justify-end q-gutter-sm full-width"},ot={class:"modal-header"},lt={class:"text-h6 flex items-center"},it={key:0,class:"modal-content-grid"},rt={class:"modal-column"},nt={class:"data-grid"},dt={class:"data-row"},ct={class:"data-value"},ut={class:"data-row"},mt={class:"data-value"},pt={class:"data-row"},ft={class:"data-value"},vt={class:"data-row"},gt={class:"data-value"},bt={class:"data-row"},ht={class:"data-value"},yt={class:"modal-column"},wt={class:"data-grid"},_t={class:"data-row"},Nt={class:"data-value"},xt={class:"data-row"},At={class:"data-value"},Vt={class:"data-row"},qt={class:"data-value"},Tt={class:"data-row"},Ct={class:"data-value"},Et={__name:"MyApprentices",setup(zt){const q=Ne(),ae=Ae(),c=P(null),oe=P({}),E=P(null),{error:_,success:M}=Ie(),le=()=>({_id:"",documentType:"",documentNumber:"",firstName:"",lastName:"",phone:"",emailInstitutional:"",emailPersonal:"",fiche:""}),z={list:"/apprentices/listApprentice",create:"/apprentices/saveApprentice"},T={listError:"Error al listar aprendices",createSuccess:"Aprendiz agregado correctamente",createError:"Error al agregar el aprendiz",noData:"No hay aprendices registrados en esta ficha"},$=a=>{const t=c.value;return{documentNumber:a.documentNumber?.trim(),documentType:a.documentType,recordNumber:[{fiche:t}],firstName:a.firstName?.trim(),lastName:a.lastName?.trim(),email:{institutional:a.emailInstitutional?.trim(),personal:a.emailPersonal?.trim()},phone:a.phone?.trim(),password:a.documentNumber?.trim()}},j=a=>!a||!a.fiche?null:typeof a.fiche=="string"||typeof a.fiche=="number"?a.fiche.toString().trim():typeof a.fiche=="object"?(a.fiche.number||a.fiche.code||a.fiche._id||a.fiche.fiche)?.toString().trim():(a.number||a.code)?.toString().trim(),R=a=>{const t=a?.msg?.Apprentice||[];if(!c.value)return{data:[],total:0};let e=t.filter(g=>!g.recordNumber||!Array.isArray(g.recordNumber)?!1:g.recordNumber.some(k=>j(k)===c.value.toString().trim()));const r=u.value.search?.trim().toLowerCase();r&&(e=e.filter(g=>{const k=`${g.firstName||""} ${g.lastName||""}`.toLowerCase(),O=(g.documentNumber||"").toString().toLowerCase();return k.includes(r)||O.includes(r)})),u.value.status!==""&&u.value.status!==null&&(e=e.filter(g=>g.status===u.value.status));const{page:v,rowsPerPage:V}=p.value,f=(v-1)*V,ye=f+V;return{data:e.slice(f,ye),total:e.length}},{loading:N,loadingTable:D,rows:x,showAddDialog:A,showDetailDialog:F,selectedEntity:ie,formData:n,filtersData:u,pagination:p,handlePaginationRequest:re,resetPaginationState:L,openFormDialog:ne,closeFormDialog:de,openDetailsDialog:ce,handleAddDialogVisibility:I}=ke({entityName:"aprendiz",entityNamePlural:"apprentices",getDefaultFormData:le,endpoints:z,messages:T,buildPayload:$,processResponse:R}),m=ie,ue=ne,me=de,pe=ce,fe=re,h=async()=>{if(!c.value){x.value=[],p.value.rowsNumber=0;return}D.value=!0;try{const a={page:1,limit:1e3},t=await U(z.list,{params:a}),e=R(t);x.value=e.data,p.value.rowsNumber=e.total}catch(a){const t=a?.response?.data?.msg||a?.message||T.listError;_(t),x.value=[],p.value.rowsNumber=0}finally{D.value=!1}},Z=async a=>{try{return((await U("/apprentices/listApprentice",{params:{page:1,limit:10,search:a}}))?.msg?.Apprentice||[]).find(v=>v.documentNumber?.toString()===a.toString())||null}catch{return null}},H=async()=>{if(E.value&&!await E.value.validate()){_("Por favor complete todos los campos requeridos correctamente");return}if(!c.value){_("No hay una ficha seleccionada. Por favor selecciona una ficha primero.");return}N.value=!0;const a=await Z(n.value.documentNumber?.trim());if(a){const e=a.recordNumber?.map(j).filter(Boolean);if(e&&e.length>0){const r=e.join(", ");_(`El aprendiz con documento ${n.value.documentNumber} ya está registrado en la(s) ficha(s): ${r}. Un aprendiz solo puede estar en una ficha a la vez.`),N.value=!1;return}}const t=$(n.value);try{const e=await Fe(z.create,t),r=e?.msg||e?.message||e?.data?.msg||T.createSuccess;M(r),A.value=!1,I(!1),setTimeout(async()=>{await h()},300)}catch(e){if(e?.response?.status===500&&(await new Promise(V=>setTimeout(V,500)),await Z(n.value.documentNumber?.trim()))){M("Aprendiz agregado correctamente"),A.value=!1,I(!1),setTimeout(async()=>{await h()},300),N.value=!1;return}let r=T.createError;if(e?.response?.data?.errors){const v=e.response.data.errors;Array.isArray(v)?r=v.map(f=>typeof f=="string"?f:f.msg?f.msg:f.message?f.message:JSON.stringify(f)).join(", "):typeof v=="string"&&(r=v)}else e?.response?.data?.msg?r=e.response.data.msg:e?.message&&(r=e.message);_(r)}finally{N.value=!1}},ve=[{label:"Cédula de Ciudadanía",value:"CC"},{label:"Tarjeta de Identidad",value:"TI"},{label:"Cédula de Extranjería",value:"CE"}],ge=[{label:"Todos los estados",value:""},{label:"Activo",value:0},{label:"Inactivo",value:1}],be=[{name:"documentType",label:"Tipo Doc.",align:"center",field:"documentType"},{name:"documentNumber",label:"N° Documento",align:"center",field:"documentNumber"},{name:"firstName",label:"Nombres",align:"center",field:"firstName"},{name:"lastName",label:"Apellidos",align:"center",field:"lastName"},{name:"phone",label:"Teléfono",align:"center",field:"phone"},{name:"status",label:"Estado",align:"center",field:"status"},{name:"options",label:"Acciones",align:"center"}],he=()=>{c.value=null,u.value.search="",u.value.status="",x.value=[],p.value.rowsNumber=0,p.value.page=1,ae.replace({query:{}})},J=async a=>{try{const e=(await U(`/fiches/listFiche?number=${a}`))?.msg||[];if(Array.isArray(e)&&e.length>0){const r=e[0];return oe.value[a]=r._id||r.id,r._id||r.id}return null}catch(t){return console.error("Error al obtener ID de ficha:",t),null}};return S(()=>q.query.recordNumber,async a=>{a&&(c.value=a,await J(a),await h())},{immediate:!0}),S(()=>u.value.search,()=>{L(),h()}),S(()=>u.value.status,()=>{L(),h()}),_e(async()=>{q.query.recordNumber&&(c.value=q.query.recordNumber,await J(q.query.recordNumber),await h())}),(a,t)=>(Q(),xe(ze,{class:"q-pa-md apprentices-by-fiche-page"},{default:i(()=>[s("div",Ue,[l(Pe)]),s("div",Me,[s("div",$e,[l(W,{class:"shadow-1 hero-card q-mb-xl"},{default:i(()=>[l(X,null,{default:i(()=>[l(Se,{title:"Aprendices por Ficha",description:"Visualiza los aprendices asociados a la ficha seleccionada."})]),_:1})]),_:1}),c.value?(Q(),G("div",je,[l(W,{class:"shadow-1"},{default:i(()=>[l(X,null,{default:i(()=>[s("div",Re,[s("div",null,[s("div",Le,[l(w,{name:"school",class:"q-mr-sm",color:"primary"}),y(" Aprendices de la Ficha "+d(c.value),1)]),s("div",Ze," Total de aprendices: "+d(o(p).rowsNumber),1)]),s("div",He,[l(C,{label:"Añadir Aprendiz","custom-class":"gradient-btn",icon:"person_add",onClick:o(ue)},null,8,["onClick"]),l(Ve,{flat:"",round:"",icon:"close",color:"green-7",size:"md",onClick:he},{default:i(()=>[l(Ce,null,{default:i(()=>[...t[12]||(t[12]=[y("Limpiar búsqueda",-1)])]),_:1})]),_:1})])]),s("div",Je,[s("div",Oe,[s("div",Ge,[l(b,{modelValue:o(u).search,"onUpdate:modelValue":t[0]||(t[0]=e=>o(u).search=e),outlined:"",dense:"",clearable:"",debounce:"600",placeholder:"Buscar por nombre o documento...",class:"custom-green-icons"},{prepend:i(()=>[l(w,{name:"search",color:"green-7"})]),_:1},8,["modelValue"])]),s("div",Ke,[l(Y,{modelValue:o(u).status,"onUpdate:modelValue":t[1]||(t[1]=e=>o(u).status=e),options:ge,outlined:"",dense:"","emit-value":"","map-options":"",clearable:"",label:"Filtrar por Estado",class:"custom-green-icons"},{prepend:i(()=>[l(w,{name:"filter_list",color:"green-7"})]),_:1},8,["modelValue"])])])]),l(Qe,{card:"",rows:o(x),columns:be,pagination:o(p),"onUpdate:pagination":t[2]||(t[2]=e=>B(p)?p.value=e:null),"loading-table":o(D),"row-key":"_id",onRequest:o(fe)},{"body-cell-status":i(e=>[l(te,{props:e},{default:i(()=>[l(ee,{color:e.row.status===0?"positive":"negative",class:"text-uppercase"},{default:i(()=>[y(d(e.row.status===0?"Activo":"Inactivo"),1)]),_:2},1032,["color"])]),_:2},1032,["props"])]),"body-cell-options":i(e=>[l(te,{props:e,class:"text-center table-options"},{default:i(()=>[l(Be,{icon:"visibility",color:"primary",tooltip:"Ver detalles",onClick:r=>o(pe)(e.row)},null,8,["onClick"])]),_:2},1032,["props"])]),"no-data":i(()=>[s("div",We,[l(w,{name:"school",size:"2.5em",color:"grey-5"}),t[13]||(t[13]=s("div",{class:"text-subtitle2 q-mt-sm"}," No hay aprendices registrados en esta ficha ",-1))])]),_:1},8,["rows","pagination","loading-table","onRequest"])]),_:1})]),_:1})])):K("",!0),l(se,{modelValue:o(A),"onUpdate:modelValue":[t[10]||(t[10]=e=>B(A)?A.value=e:null),o(I)],variant:"edit",width:"900px","max-width":"95vw",persistent:""},{header:i(()=>[s("div",Xe,[s("div",Ye,[l(w,{name:"person_add",class:"q-mr-sm"}),y(" Agregar aprendiz a la ficha "+d(c.value),1)]),t[14]||(t[14]=s("div",{class:"text-caption text-grey-7 q-mt-xs"}," Ingresa el documento del aprendiz. Si ya existe en otra ficha, se mostrará un error. ",-1))])]),body:i(()=>[l(Ee,{ref_key:"apprenticeFormRef",ref:E,onSubmit:qe(H,["prevent"])},{default:i(()=>[s("div",et,[s("div",tt,[t[15]||(t[15]=s("div",{class:"section-title"},"Datos personales",-1)),l(Y,{modelValue:o(n).documentType,"onUpdate:modelValue":t[3]||(t[3]=e=>o(n).documentType=e),filled:"",dense:"",label:"Tipo de documento *",options:ve,"emit-value":"","map-options":"",rules:[e=>!!e||"El tipo de documento es requerido"]},null,8,["modelValue","rules"]),l(b,{modelValue:o(n).documentNumber,"onUpdate:modelValue":t[4]||(t[4]=e=>o(n).documentNumber=e),filled:"",dense:"",label:"Número de documento *",mask:"##########",rules:[e=>!!e||"El número de documento es requerido",e=>/^\d{7,10}$/.test(e)||"Debe tener entre 7 y 10 dígitos"]},null,8,["modelValue","rules"]),l(b,{modelValue:o(n).firstName,"onUpdate:modelValue":t[5]||(t[5]=e=>o(n).firstName=e),filled:"",dense:"",label:"Nombres *",rules:[e=>!!e||"Los nombres son requeridos",e=>/^[a-zA-ZáéíóúÁÉÍÓÚñÑ\s]+$/.test(e)||"Solo se permiten letras"]},null,8,["modelValue","rules"]),l(b,{modelValue:o(n).lastName,"onUpdate:modelValue":t[6]||(t[6]=e=>o(n).lastName=e),filled:"",dense:"",label:"Apellidos *",rules:[e=>!!e||"Los apellidos son requeridos",e=>/^[a-zA-ZáéíóúÁÉÍÓÚñÑ\s]+$/.test(e)||"Solo se permiten letras"]},null,8,["modelValue","rules"]),l(b,{modelValue:o(n).phone,"onUpdate:modelValue":t[7]||(t[7]=e=>o(n).phone=e),filled:"",dense:"",label:"Teléfono *",mask:"##########",rules:[e=>!!e||"El teléfono es requerido",e=>/^3[0-9]{9}$/.test(e)||"Debe tener 10 dígitos y comenzar con 3"]},null,8,["modelValue","rules"])]),s("div",st,[t[16]||(t[16]=s("div",{class:"section-title"},"Información de contacto",-1)),l(b,{modelValue:o(n).emailInstitutional,"onUpdate:modelValue":t[8]||(t[8]=e=>o(n).emailInstitutional=e),filled:"",dense:"",label:"Email institucional *",type:"email","lazy-rules":"",rules:[e=>!!e?.trim()||"El email institucional es requerido",e=>/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test((e||"").trim())||"Email inválido"]},null,8,["modelValue","rules"]),l(b,{modelValue:o(n).emailPersonal,"onUpdate:modelValue":t[9]||(t[9]=e=>o(n).emailPersonal=e),filled:"",dense:"",label:"Email personal *",type:"email","lazy-rules":"",rules:[e=>!!e?.trim()||"El email personal es requerido",e=>/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test((e||"").trim())||"Email inválido"]},null,8,["modelValue","rules"])])])]),_:1},512)]),footer:i(()=>[s("div",at,[l(C,{"custom-class":"boton-cerrar",label:"Cancelar",onClick:o(me)},null,8,["onClick"]),l(C,{label:"Agregar Aprendiz","custom-class":"gradient-btn",loading:o(N),onClick:H},null,8,["loading"])])]),_:1},8,["modelValue","onUpdate:modelValue"]),l(se,{modelValue:o(F),"onUpdate:modelValue":t[11]||(t[11]=e=>B(F)?F.value=e:null),variant:"view",width:"900px","max-width":"90vw"},{header:i(()=>[s("div",ot,[s("div",lt,[l(w,{name:"person",class:"q-mr-sm"}),y(" "+d(o(m)?.firstName||"Aprendiz")+" "+d(o(m)?.lastName||""),1)])])]),body:i(()=>[o(m)?(Q(),G("div",it,[s("div",rt,[t[22]||(t[22]=s("div",{class:"section-title"},"Datos personales",-1)),s("div",nt,[s("div",dt,[t[17]||(t[17]=s("div",{class:"text-weight-bold"},"Tipo de documento:",-1)),s("div",ct,d(o(m)?.documentType||"-"),1)]),s("div",ut,[t[18]||(t[18]=s("div",{class:"text-weight-bold"},"Número de documento:",-1)),s("div",mt,d(o(m)?.documentNumber||"-"),1)]),s("div",pt,[t[19]||(t[19]=s("div",{class:"text-weight-bold"},"Nombres:",-1)),s("div",ft,d(o(m)?.firstName||"-"),1)]),s("div",vt,[t[20]||(t[20]=s("div",{class:"text-weight-bold"},"Apellidos:",-1)),s("div",gt,d(o(m)?.lastName||"-"),1)]),s("div",bt,[t[21]||(t[21]=s("div",{class:"text-weight-bold"},"Teléfono:",-1)),s("div",ht,d(o(m)?.phone||"-"),1)])])]),s("div",yt,[t[27]||(t[27]=s("div",{class:"section-title"},"Información de contacto",-1)),s("div",wt,[s("div",_t,[t[23]||(t[23]=s("div",{class:"text-weight-bold"},"Email institucional:",-1)),s("div",Nt,d(o(m)?.email?.institutional||"-"),1)]),s("div",xt,[t[24]||(t[24]=s("div",{class:"text-weight-bold"},"Email personal:",-1)),s("div",At,d(o(m)?.email?.personal||"-"),1)]),s("div",Vt,[t[25]||(t[25]=s("div",{class:"text-weight-bold"},"Ficha:",-1)),s("div",qt,d(c.value||"-"),1)]),s("div",Tt,[t[26]||(t[26]=s("div",{class:"text-weight-bold"},"Estado:",-1)),s("div",Ct,[l(ee,{color:o(m)?.status===0?"positive":"negative",class:"text-uppercase"},{default:i(()=>[y(d(o(m)?.status===0?"Activo":"Inactivo"),1)]),_:1},8,["color"])])])])])])):K("",!0)]),footer:i(()=>[Te(l(C,{label:"Cerrar","custom-class":"boton-cerrar"},null,512),[[De]])]),_:1},8,["modelValue"])])])]),_:1}))}},ts=we(Et,[["__scopeId","data-v-fe86d4f9"]]);export{ts as default};
