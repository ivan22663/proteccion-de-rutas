import{_ as _t,r as y,a5 as bt,h as m,b as o,d as e,a as r,f as yt,e as l,i as J,af as K,o as p,s as ht,c as W,g as h,j as w,ae as Y,t as c,z as D,F as N,p as V}from"./index-D8k0Z2VW.js";import{a as T}from"./QSelect-CCFBgF8v.js";import{Q as Z}from"./QTd-Dz2_L_T4.js";import{C}from"./ClosePopup-DkFGp95i.js";import{u as wt}from"./useEntityManager-6kUzRwOq.js";import{u as Dt}from"./useNotifications-C15CMF32.js";import{g as X}from"./apiClient-Vvvjylwf.js";import{B as Ct}from"./BackButton-OAicZK4q.js";import{P as At}from"./PageHeader-BZtJRD6F.js";import{B as A}from"./Button-ByZOtwGJ.js";import{_ as xt}from"./ButtonTableOptions-ivpzFDPv.js";import{T as St}from"./Table-DrGgNztj.js";import{M as x}from"./Modal-CwwUMTwV.js";import{S as $}from"./StatsCard-CWZ95buy.js";import"./QItemLabel-BiKvV_tR.js";import"./position-engine-BrzQKXCo.js";import"./selection-CjJDPdFp.js";import"./format-DyQxkAtJ.js";import"./QTooltip-BIz5X8HU.js";import"./QList-D6hH9GPe.js";import"./QLinearProgress-C9Sex94R.js";const Nt={class:"q-pa-md"},Vt={class:"container"},$t={class:"statistics-section q-mb-xl"},kt={class:"statistics-grid"},qt={class:"filters-wrapper flex items-center justify-between q-my-lg"},Et={class:"filters-left flex items-center bg-white"},Mt={class:"filter-item"},Ut={class:"filter-item"},Pt={class:"q-pa-md flex flex-center column text-grey full-width"},Rt={class:"text-subtitle2 q-mt-sm"},It={key:0,class:"row q-col-gutter-lg"},Lt={class:"col-12 col-md-6"},Ot={class:"data-grid"},Bt={class:"data-row"},Ft={class:"data-value"},Tt={class:"data-row"},jt={class:"data-value"},Qt={class:"data-row"},Ht={class:"data-value"},Gt={class:"data-row"},zt={class:"data-value"},Jt={class:"data-row"},Kt={class:"data-value"},Wt={class:"data-row"},Yt={class:"data-value"},Zt={class:"col-12 col-md-6"},Xt={class:"data-grid"},te={class:"data-row"},ee={class:"data-value"},se={class:"data-row"},ae={class:"data-value"},oe={class:"data-row"},le={class:"data-value"},ie={class:"data-row"},ne={class:"data-value"},re={key:0,class:"col-12"},de={class:"modal-content-grid"},ce={class:"modal-column",style:{"grid-column":"1 / -1"}},ue={class:"data-grid"},ve={class:"data-row"},pe={class:"data-value"},me={class:"json-content"},fe={key:1,class:"col-12"},ge={class:"modal-content-grid"},_e={class:"modal-column",style:{"grid-column":"1 / -1"}},be={class:"data-grid"},ye={class:"data-row"},he={class:"data-value"},we={class:"statistics-content"},De={class:"stat-label"},Ce={class:"stat-count"},Ae={class:"statistics-content"},xe={class:"stat-label"},Se={class:"stat-count"},Ne={class:"statistics-content"},Ve={class:"stat-label"},$e={class:"stat-count"},ke={class:"statistics-content"},qe={class:"stat-label"},Ee={class:"stat-count"},Me={__name:"logs",setup(Ue){const{error:j}=Dt(),f=y({byAction:{data:[],uniqueCount:0,totalCount:0},byModule:{data:[],uniqueCount:0,totalCount:0},byLevel:{data:[],uniqueCount:0,totalCount:0},byUser:{data:[],uniqueCount:0,totalCount:0}}),k=y(!1),q=y(!1),E=y(!1),M=y(!1),tt=()=>({_id:"",fecha:"",usuario:"",accion:"",modulo:"",nivel:"",descripcion:"",tabla_afectada:"",registro_afectado:"",datos_anteriores:null,datos_nuevos:null,ip:""}),Q={list:"/logs/filterLogs"},H={listError:"Error al cargar los logs",noData:"No hay logs registrados"},G=a=>{const t=a?.data||[],s=Array.isArray(t)?t.map(n=>({_id:n._id,fecha:n.createdAt,usuario:n.user,accion:n.action,modulo:n.module,nivel:n.level,descripcion:n.description,tabla_afectada:n.affectedTable,registro_afectado:n.affectedRecordId,datos_anteriores:n.previousData,datos_nuevos:n.newData,ip:n.ipAddress})):[],i=(a?.pagination||{}).totalRecords||a?.total||a?.totalCount||s.length;return{data:s,total:i}},{loadingTable:U,rows:P,showDetailDialog:et,selectedEntity:st,filtersData:u,pagination:g,resetPaginationState:at,openDetailsDialog:ot}=wt({entityName:"log",entityNamePlural:"logs",getDefaultFormData:tt,endpoints:Q,messages:H,processResponse:G});u.value.startDate="",u.value.endDate="",g.value={sortBy:"fecha",descending:!0,page:1,rowsPerPage:10,rowsNumber:0};const lt=P,v=st,R=et,it=U,nt=ot,rt=async()=>{try{const t=[{key:"byAction",url:"/statistics/logs/by-action"},{key:"byModule",url:"/statistics/logs/by-module"},{key:"byLevel",url:"/statistics/logs/by-level"},{key:"byUser",url:"/statistics/logs/by-user"}].map(async({key:s,url:d})=>{try{const i=await X(d);let n=[];i?.data&&Array.isArray(i.data)?n=i.data:i?.statistics&&Array.isArray(i.statistics)?n=i.statistics:i?.data?.statistics&&Array.isArray(i.data.statistics)?n=i.data.statistics:(console.warn(`No statistics found for ${s}`,i),n=[]);const _=n.filter(b=>{const F=b._id!==null&&b._id!==void 0&&b._id!=="",gt=typeof b.count=="number"&&b.count>0;return F&&gt}),B=_.length,ft=_.reduce((b,F)=>b+(F.count||0),0);f.value[s]={data:_,uniqueCount:B,totalCount:ft}}catch(i){console.error(`Error fetching ${s}:`,i),f.value[s]={data:[],uniqueCount:0,totalCount:0}}});await Promise.all(t)}catch(a){console.error("Error fetching statistics:",a),j("Error al cargar las estadísticas")}},I=async()=>{const{page:a,rowsPerPage:t}=g.value;U.value=!0;try{const s={page:a,limit:t};u.value.startDate&&(s.startDate=u.value.startDate),u.value.endDate&&(s.endDate=u.value.endDate);const d=await X(Q.list,{params:s}),i=G(d);P.value=i.data,g.value.rowsNumber=i.total}catch(s){const d=s?.response?.data?.msg||s?.message||H.listError;j(d),P.value=[],g.value.rowsNumber=0}finally{U.value=!1}},S=()=>{at(),I()},dt=()=>{u.value.startDate="",S()},ct=()=>{u.value.endDate="",S()},ut=a=>{a?.pagination&&(g.value={page:a.pagination.page,rowsPerPage:a.pagination.rowsPerPage,rowsNumber:a.pagination.rowsNumber??g.value.rowsNumber},I())};function z(a){if(!a)return"-";try{const t=new Date(a),s=String(t.getDate()).padStart(2,"0"),d=String(t.getMonth()+1).padStart(2,"0"),i=t.getFullYear(),n=String(t.getHours()).padStart(2,"0"),_=String(t.getMinutes()).padStart(2,"0"),B=String(t.getSeconds()).padStart(2,"0");return`${s}/${d}/${i} ${n}:${_}:${B}`}catch{return"-"}}function vt(a){if(!a)return"";try{return JSON.stringify(a,null,2)}catch{return String(a)}}function L(a,t=0){if(!a)return"";const s="  ".repeat(t);let d="";if(typeof a=="object"&&!Array.isArray(a))for(const[i,n]of Object.entries(a)){const _=i.charAt(0).toUpperCase()+i.slice(1).replace(/([A-Z])/g," $1");d+=`${s}${_}:
`,typeof n=="object"&&n!==null?d+=L(n,t+1):d+=`${s}  ${n}
`,d+=`
`}else Array.isArray(a)?a.forEach((i,n)=>{d+=`${s}${n+1}.
`,typeof i=="object"&&i!==null?d+=L(i,t+1):d+=`${s}  ${i}
`,d+=`
`}):d=`${s}${a}
`;return d}function O(a){return{INFO:"blue",WARNING:"orange",ERROR:"red",CRITICAL:"deep-orange",DEBUG:"grey"}[a]||"grey"}function pt(a){nt(a)}const mt=[{name:"fecha",label:"Fecha",field:"fecha",sortable:!0,align:"left",format:a=>z(a)},{name:"usuario",label:"Usuario",field:"usuario",sortable:!0,align:"left"},{name:"accion",label:"Acción",field:"accion",sortable:!0,align:"center"},{name:"modulo",label:"Módulo",field:"modulo",sortable:!0,align:"center"},{name:"nivel",label:"Nivel",field:"nivel",sortable:!0,align:"center"},{name:"descripcion",label:"Descripción",field:"descripcion",sortable:!1,align:"left"},{name:"opciones",label:"Opciones",align:"center"}];return bt(()=>{I(),rt()}),(a,t)=>(p(),m("div",Nt,[o(Ct),o(yt,{class:"shadow-1 hero-card q-mb-xl"},{default:r(()=>[o(ht,null,{default:r(()=>[o(At,{title:"Registros",description:"Registro de Actividades del Sistema."})]),_:1})]),_:1}),e("div",Vt,[e("div",$t,[e("div",kt,[o($,{title:"POR ACCIÓN",value:f.value.byAction.uniqueCount,color:"var(--color-primary)",onClick:t[0]||(t[0]=s=>k.value=!0),class:"cursor-pointer"},null,8,["value"]),o($,{title:"POR MÓDULO",value:f.value.byModule.uniqueCount,color:"var(--color-primary)",onClick:t[1]||(t[1]=s=>q.value=!0),class:"cursor-pointer"},null,8,["value"]),o($,{title:"POR NIVEL",value:f.value.byLevel.uniqueCount,color:"var(--color-primary)",onClick:t[2]||(t[2]=s=>E.value=!0),class:"cursor-pointer"},null,8,["value"]),o($,{title:"POR USUARIO",value:f.value.byUser.uniqueCount,color:"var(--color-primary)",onClick:t[3]||(t[3]=s=>M.value=!0),class:"cursor-pointer"},null,8,["value"])])]),e("div",qt,[e("div",Et,[e("div",Mt,[t[12]||(t[12]=e("label",{class:"filter-label"},"FECHA DESDE",-1)),o(J,{modelValue:l(u).startDate,"onUpdate:modelValue":[t[4]||(t[4]=s=>l(u).startDate=s),S],outlined:"",dense:"",type:"date",placeholder:"DD/MM/AAAA"},{prepend:r(()=>[o(w,{name:"event",color:"green-8"})]),append:r(()=>[l(u).startDate?(p(),W(w,{key:0,name:"close",class:"cursor-pointer",onClick:Y(dt,["stop"])})):h("",!0)]),_:1},8,["modelValue"])]),e("div",Ut,[t[13]||(t[13]=e("label",{class:"filter-label"},"FECHA HASTA",-1)),o(J,{modelValue:l(u).endDate,"onUpdate:modelValue":[t[5]||(t[5]=s=>l(u).endDate=s),S],outlined:"",dense:"",type:"date",placeholder:"DD/MM/AAAA"},{prepend:r(()=>[o(w,{name:"event",color:"green-8"})]),append:r(()=>[l(u).endDate?(p(),W(w,{key:0,name:"close",class:"cursor-pointer",onClick:Y(ct,["stop"])})):h("",!0)]),_:1},8,["modelValue"])])])]),o(St,{card:"",rows:l(lt),columns:mt,"row-key":"_id","loanding-table":l(it),"rows-per-page-options":[10,20,50],pagination:l(g),"onUpdate:pagination":t[6]||(t[6]=s=>K(g)?g.value=s:null),onRequest:ut},{"body-cell-nivel":r(s=>[o(Z,{props:s},{default:r(()=>[o(T,{color:O(s.value),"text-color":"white",dense:"",label:s.value},null,8,["color","label"])]),_:2},1032,["props"])]),"body-cell-opciones":r(s=>[o(Z,{props:s},{default:r(()=>[o(xt,{icon:"visibility",color:"grey",tooltip:"Ver detalles",onClick:d=>pt(s.row)},null,8,["onClick"])]),_:2},1032,["props"])]),"no-data":r(()=>[e("div",Pt,[o(w,{name:"history",size:"2.5em",color:"primary"}),e("div",Rt,c(l(u).startDate||l(u).endDate?"No se encontraron logs con los filtros aplicados":"No hay logs registrados"),1)])]),_:1},8,["rows","loanding-table","pagination"])]),o(x,{modelValue:l(R),"onUpdate:modelValue":t[7]||(t[7]=s=>K(R)?R.value=s:null),variant:"view",width:"1200px","max-width":"98vw"},{header:r(()=>[...t[14]||(t[14]=[e("div",{class:"text-h6"},"Detalles del Log",-1)])]),body:r(()=>[l(v)?(p(),m("div",It,[e("div",Lt,[t[21]||(t[21]=e("div",{class:"text-h6 q-mb-md section-title"},"Información General",-1)),e("div",Ot,[e("div",Bt,[t[15]||(t[15]=e("div",{class:"text-weight-bold"},"ID:",-1)),e("div",Ft,c(l(v)._id||"-"),1)]),e("div",Tt,[t[16]||(t[16]=e("div",{class:"text-weight-bold"},"Fecha:",-1)),e("div",jt,c(z(l(v).fecha)),1)]),e("div",Qt,[t[17]||(t[17]=e("div",{class:"text-weight-bold"},"Usuario:",-1)),e("div",Ht,c(l(v).usuario||"-"),1)]),e("div",Gt,[t[18]||(t[18]=e("div",{class:"text-weight-bold"},"Acción:",-1)),e("div",zt,c(l(v).accion||"-"),1)]),e("div",Jt,[t[19]||(t[19]=e("div",{class:"text-weight-bold"},"Módulo:",-1)),e("div",Kt,c(l(v).modulo||"-"),1)]),e("div",Wt,[t[20]||(t[20]=e("div",{class:"text-weight-bold"},"IP:",-1)),e("div",Yt,c(l(v).ip||"-"),1)])])]),e("div",Zt,[t[26]||(t[26]=e("div",{class:"text-h6 q-mb-md section-title"},"Detalles Técnicos",-1)),e("div",Xt,[e("div",te,[t[22]||(t[22]=e("div",{class:"text-weight-bold"},"Descripción:",-1)),e("div",ee,c(l(v).descripcion||"Sin descripción"),1)]),e("div",se,[t[23]||(t[23]=e("div",{class:"text-weight-bold"},"Nivel:",-1)),e("div",ae,[o(T,{color:O(l(v).nivel),"text-color":"white",dense:"",label:l(v).nivel},null,8,["color","label"])])]),e("div",oe,[t[24]||(t[24]=e("div",{class:"text-weight-bold"},"Tabla Afectada:",-1)),e("div",le,c(l(v).tabla_afectada||"-"),1)]),e("div",ie,[t[25]||(t[25]=e("div",{class:"text-weight-bold"},"ID Registro:",-1)),e("div",ne,c(l(v).registro_afectado||"null"),1)])])]),l(v).datos_anteriores?(p(),m("div",re,[t[27]||(t[27]=e("div",{class:"text-h6 q-mb-md section-title"},"Datos Anteriores",-1)),e("div",de,[e("div",ce,[e("div",ue,[e("div",ve,[e("div",pe,[e("pre",me,c(vt(l(v).datos_anteriores)),1)])])])])])])):h("",!0),l(v).datos_nuevos?(p(),m("div",fe,[t[28]||(t[28]=e("div",{class:"text-h6 q-mb-md section-title"},"Datos Nuevos",-1)),e("div",ge,[e("div",_e,[e("div",be,[e("div",ye,[e("div",he,c(L(l(v).datos_nuevos)),1)])])])])])):h("",!0)])):h("",!0)]),footer:r(()=>[D(o(A,{label:"Cerrar","custom-class":"boton-cerrar"},null,512),[[C]])]),_:1},8,["modelValue"]),o(x,{modelValue:k.value,"onUpdate:modelValue":t[8]||(t[8]=s=>k.value=s),variant:"view",width:"800px"},{header:r(()=>[...t[29]||(t[29]=[e("div",{class:"text-h6"},"Estadísticas por Acción",-1)])]),body:r(()=>[e("div",we,[(p(!0),m(N,null,V(f.value.byAction.data,s=>(p(),m("div",{key:s._id,class:"stat-item"},[e("div",De,c(s._id||"Sin especificar"),1),e("div",Ce,c(s.count),1)]))),128))])]),footer:r(()=>[D(o(A,{label:"Cerrar","custom-class":"boton-cerrar"},null,512),[[C]])]),_:1},8,["modelValue"]),o(x,{modelValue:q.value,"onUpdate:modelValue":t[9]||(t[9]=s=>q.value=s),variant:"view",width:"800px"},{header:r(()=>[...t[30]||(t[30]=[e("div",{class:"text-h6"},"Estadísticas por Módulo",-1)])]),body:r(()=>[e("div",Ae,[(p(!0),m(N,null,V(f.value.byModule.data,s=>(p(),m("div",{key:s._id,class:"stat-item"},[e("div",xe,c(s._id||"Sin especificar"),1),e("div",Se,c(s.count),1)]))),128))])]),footer:r(()=>[D(o(A,{label:"Cerrar","custom-class":"boton-cerrar"},null,512),[[C]])]),_:1},8,["modelValue"]),o(x,{modelValue:E.value,"onUpdate:modelValue":t[10]||(t[10]=s=>E.value=s),variant:"view",width:"800px"},{header:r(()=>[...t[31]||(t[31]=[e("div",{class:"text-h6"},"Estadísticas por Nivel",-1)])]),body:r(()=>[e("div",Ne,[(p(!0),m(N,null,V(f.value.byLevel.data,s=>(p(),m("div",{key:s._id,class:"stat-item"},[e("div",Ve,c(s._id||"Sin especificar"),1),e("div",$e,c(s.count),1),o(T,{color:O(s._id),"text-color":"white",dense:"",label:s._id},null,8,["color","label"])]))),128))])]),footer:r(()=>[D(o(A,{label:"Cerrar","custom-class":"boton-cerrar"},null,512),[[C]])]),_:1},8,["modelValue"]),o(x,{modelValue:M.value,"onUpdate:modelValue":t[11]||(t[11]=s=>M.value=s),variant:"view",width:"800px"},{header:r(()=>[...t[32]||(t[32]=[e("div",{class:"text-h6"},"Estadísticas por Usuario",-1)])]),body:r(()=>[e("div",ke,[(p(!0),m(N,null,V(f.value.byUser.data,s=>(p(),m("div",{key:s._id,class:"stat-item"},[e("div",qe,c(s._id||"Sin especificar"),1),e("div",Ee,c(s.count),1)]))),128))])]),footer:r(()=>[D(o(A,{label:"Cerrar","custom-class":"boton-cerrar"},null,512),[[C]])]),_:1},8,["modelValue"])]))}},ss=_t(Me,[["__scopeId","data-v-9b908816"]]);export{ss as default};
